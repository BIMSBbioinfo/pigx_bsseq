---
title: "PiGx: BS-seq"
output: 
  html_notebook:
    toc:        TRUE
    toc_float:  TRUE
    theme:      "lumen"
    number_sections: FALSE
    code_folding: "hide"
    self_contained: TRUE
    includes:
      in_header: pigx_bsseq_logo.html
date: "`r Sys.Date()`"
#bibliography: reports.bib
params:
  inputfiles: ["methylation_calls/sampleA.pe1_trimmed_bismark_bt2.deduplicated.sorted_methylRaw.RData","methylation_calls/sampleA.pe1_trimmed_bismark_bt2.deduplicated.sorted_methylRaw.RData"]
  grdata: "segmentation/sampleA.pe1_trimmed_bismark_bt2.deduplicated.sorted_meth_windows_gr.RData"
  grdata_hyper: "segmentation/sampleA.pe1_trimmed_bismark_bt2.deduplicated.sorted_meth_windows_gr.RData"
  grdata_hypo: "segmentation/sampleA.pe1_trimmed_bismark_bt2.deduplicated.sorted_meth_windows_gr.RData"
  outBed:   "segmentation/sampleA.pe1_trimmed_bismark_bt2.deduplicated.sorted_meth_windows.bed"
  sampleids: ["sampleA", "sampleB"]
  assembly: "ce10"
  treatment: [0,1]
  mincov: 0
  context: "CpG"
  workdir: "~/outputdir/"
  cores: 2
---
  
  
```{r eval_params, echo=FALSE}

input     <- params$inputfiles
sampleids <- params$sampleids
output    <- params$outBed
grFile    <- params$grdata
grFile_hyper    <- params$grdata_hyper
grFile_hypo    <- params$grdata_hypo
assembly  <- params$assembly
treatment <- params$treatment
mincov    <- params$mincov
context   <- params$context
workdir   <- params$workdir
cores     <- params$cores


saveRDS(params, "~/tmp/params_diffmeth.rds") ### sth is wrong in the calculateDiffMeth function, I dont know what.

```

# Differential methylation report

## Calling differentially methylated bases

The logistic regression is applied to model the log odds ratio which is based on methylation proportion of a CpG using the treatment vector which denotes the sample group membership for the CpGs in the model. 

After q-value calculation, differentially methylated bases are extracted based on q-value and percent methylation difference cutoffs. Here we select bases that have q-value < 0.01 and percent methylation difference larger than 25%. Futhermore, we calculate hyper-methylated or hypo-methylated bases. 

Overdispersion occurs when there is more variability in the data than assumed by the distribution and is here included in the differentially methylatation calculation.

For more details about `calculateDiffMeth()` and `getMethylDiff()` functions see [@methylKit2012] and for details about
the logistic regression and overdispersion see [@Wreczycka2017].


```{r, include=FALSE,warning=FALSE}

suppressPackageStartupMessages(expr = {
  ## load methylKit
  library("methylKit",warn.conflicts = FALSE,quietly = TRUE)
  library("DT",warn.conflicts = FALSE,quietly = TRUE)
})

```

### Libraries
```{r load libraries, eval=FALSE, include=TRUE}

## load libraries
library("methylKit")
library("DT")

```

### Parameters
```{r print_params, echo=TRUE}

inputParams <- data.frame(sampleids=sampleids,
                          input1 = input[1],
                          input2 = input[2],
                          treatment=treatment,
                          context=context,
                          mincov=mincov,
                          assembly=assembly,
                          output=output,
                          RDSfile=grFile,
                          stringsAsFactors = FALSE)

datatable(inputParams,
          options = list(dom="t", autoWidth = TRUE, scrollX=TRUE, colReorder = TRUE),
          rownames = FALSE, class = 'cell-border stripe')

```

### Load methylation profiles


```{r load methylation, echo=TRUE, warning=FALSE}

# Treatment can have onyl numeric values
treatment = as.numeric(treatment)

inputfiles = paste0(workdir, input)
methRawList.obj = methRead(as.list(inputfiles),
                                sample.id = as.list(sampleids),
                                assembly = assembly,
                                treatment=treatment,
                                context = context,
                                mincov = mincov
)

```

### Find differentially methylated bases


```{r, differential methylation, echo=TRUE,warning=FALSE}

methylDiff2df_roundint = function(methylDiff.obj, roundval=4){
  df = as(methylDiff.obj, "data.frame")
  df[,5:7] = round(df[,5:7], roundval)
  return(df)
}


# Take bases with coverage from all samples are retained
meth.unite=unite(methRawList.obj, destrand=FALSE)

# Cutoff for absolute value of methylation percentage change
# between test and control
difference = 25
# Cutoff for qvalue of differential methylation statistic
qvalue = 0.01

if(nrow(meth.unite)>1){
  
  meth.diffmeth <- calculateDiffMeth(meth.unite, 
                                   overdispersion="MN",
                                   adjust = "qvalue",
                                   test="Chisq",
                                   mc.cores=cores)

  # Get differentially methylated regions/bases based on cutoffs  
  methylDiff.obj = getMethylDiff(meth.diffmeth, 
                                           difference=difference,
                                           type="all",
                                           qvalue=qvalue)
  # Get hypo-methylated
  methylDiff.obj.hypo = getMethylDiff(meth.diffmeth,
                                           difference=difference,
                                           type="hypo",
                                           qvalue=qvalue)
  # Get hyper-methylated
  methylDiff.obj.hyper = getMethylDiff(meth.diffmeth,
                                           difference=difference,
                                           type="hyper",
                                           qvalue=qvalue)

  ## show differentially methylated regions
  if(nrow(methylDiff.obj)!=0){
    ## show all differentially methylated regions
    datatable(methylDiff2df_roundint(methylDiff.obj),
              extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                scrollX = TRUE),
              caption = "Differentially methylated bases",
              rownames = FALSE)
    ## show hyper-methylated region
    datatable(methylDiff2df_roundint(methylDiff.obj.hyper),
              extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                scrollX = TRUE),
              caption = "Hyper-methylated bases",
              rownames = FALSE)
    ## show hypo-methylated region
    datatable(methylDiff2df_roundint(methylDiff.obj.hypo),
              extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip',
                buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                scrollX = TRUE),
              caption = "Hypo-methylated bases",
              rownames = FALSE)
    
  }else{
    print("There are no differentially methylated bases")
  }

}else{
  print("There are no bases with coverage in all samples")
}


methylDiff2df_roundint = function(methylDiff.obj, roundval=4){
  df = as(methylDiff.obj, "data.frame")
  df[,5:7] = round(df[,5:7], roundval)
  return(df)
}

```


### Export differentially methylated bases

Finally we export the regions to a *BED* file, which can be loaded into any genome browser like [IGV](http://software.broadinstitute.org/software/igv/) or [UCSC](https://genome.ucsc.edu/) to allow for further analysis, annotation and visualisation. 

```{r export to bed,warning=FALSE}

#' Export windows to a BED file
#' 
#' The windows are color coded based on their score (methylation or differential
#' methylation value).
#' 
#' @param windows \code{\link[GenomicRanges]{GRanges}} object with information about
#' differentially methylated regions
#' @param filename name of the output data
#' @param trackLine UCSC browser trackline
#' @param colramp color scale to be used in the BED display
#' defaults to gray,green, darkgreen scale.
#' 
#' @return A BED files with the differentially methylated regions
#' which can be visualized in the UCSC browser 
#' 
#' @seealso \code{\link{methylKit::methSeg2bed}}
#' 
#' @export
#' @docType methods
#' @rdname meth2bed
meth2bed<-function(windows,filename,
    trackLine="track name='meth windows' description='meth windows' itemRgb=On",
    colramp=colorRamp(c("gray","green", "darkgreen"))
                        ){
  
  range01 <- function(x){(x-min(x)+1)/(max(x)-min(x)+1)}

  if(class(windows)!="GRanges"){
    stop("windows object has to be of class GRanges")
  }
  
  ## case if only one line is exported
  if(is.null(colramp) | length(windows)==1){
    trackLine <- gsub(pattern = "itemRgb=On",replacement = "",x = trackLine)
  } else {
    require(rtracklayer)
    ramp <- colramp
    score(windows)=range01(windows$meth.diff)
    mcols(windows)$itemRgb= rgb(ramp(score(windows)), maxColorValue = 255)     
  }
  
  strand(windows)="*"
  score(windows)=range01(windows$meth.diff)
  
  if(is.null(trackLine)){
    
    export.bed(windows,filename)
  }else{
    export.bed(windows,filename,
               trackLine=as(trackLine, "BasicTrackLine"))
  }
}



# Export differentially methylated bases

if(nrow(meth.unite)>1){
    if(nrow(methylDiff.obj)!=0){
      # Convert a methylDiff object to a GRanges object
      meth.diffmeth.gr = as(methylDiff.obj, "GRanges")
      
      # Export differentially methylated bases to a bed file
      trackLine = paste0("track name='differentially methylated bases ' ",
                         "description='diff. meth. between ",
                         paste(meth.diffmeth@sample.ids,collapse=","),
                         " mapped to ",
                         meth.diffmeth@assembly,
                         "' itemRgb=On")
      meth2bed(windows = meth.diffmeth.gr,
               trackLine=trackLine,
               colramp=colorRamp(c("gray","green", "darkgreen")),
               filename = output)       
    }

}

```

The methylDiff object from the methylKit package is saved to enable fast loading for further analysis.
```{r}
is.defined <- function(sym) {
  sym <- deparse(substitute(sym))
  env <- parent.frame()
  exists(sym, env)
}

if(nrow(meth.unite)>=1 & is.defined(methylDiff.obj)==TRUE){

  ## Saving object from methylDiff to a RDS file
  saveRDS(methylDiff.obj, grFile)
  saveRDS(methylDiff.obj.hypo, grFile_hypo)
  saveRDS(methylDiff.obj.hyper, grFile_hyper)
  
}
```


```{r, echo=FALSE}

# In case when there are no differentially methylated bases
# create an empty output
trackLine = paste0("track name='differentially methylated bases ' ",
                               "description='diff. meth. between ",
                               paste(meth.unite@sample.ids,collapse=","),
                               " mapped to ",
                               meth.unite@assembly,
                               "' itemRgb=On")
if(nrow(meth.unite)<=1){
  fileConn<-file(output)
  writeLines("trackLine", fileConn)
  close(fileConn)
  
  saveRDS(meth.unite, grFile)
  saveRDS(meth.unite, grFile_hypo)
  saveRDS(meth.unite, grFile_hyper)
}

if(nrow(meth.unite)>1 & is.defined(methylDiff.obj)==TRUE & nrow(methylDiff.obj)==0 ){
  fileConn<-file(output)
  writeLines("trackLine", fileConn)
  close(fileConn)
  
  saveRDS(methylDiff.obj, grFile)
  saveRDS(methylDiff.obj, grFile_hypo)
  saveRDS(methylDiff.obj, grFile_hyper)
}

if(nrow(meth.unite)>1 & is.defined(methylDiff.obj)==FALSE){
  fileConn<-file(output)
  writeLines("trackLine", fileConn)
  close(fileConn)
  
  saveRDS(NULL, grFile)
  saveRDS(NULL, grFile_hypo)
  saveRDS(NULL, grFile_hyper)
}
```

## Session Info

```{r sessioninfo}
sessionInfo()
```



## References