#!/bin/sh

set -e
set -u

root=$(mktemp --tmpdir -d "pigx.XXXX")
testfolder=${root}/tests/test_mapping_bismark
mkdir -p ${testfolder}

echo "TEST FOLDER: ${testfolder}"

# copy necessary input files to the test folder
# we copy them to avoid re-creating these files when testing the pipeline
cp -r ${srcdir}/tests/sample_data/preprocessed/02_trimming ${testfolder}
cp -r ${srcdir}/tests/sample_data/preprocessed/03_posttrimming_QC ${testfolder}

# make these copies writable
chmod +w -R ${testfolder}

# prepare temporary sample sheet and settings files
settings=${srcdir}/tests/settings_no_de.yaml
tmp_settings="${testfolder}/settings.yaml"
sed -e "s,input-dir: ,input-dir: ${srcdir}/tests/,g" \
	    -e "s,genome-fasta: ,genome-fasta: ${srcdir}/tests/,g" \
				    -e "s,output-dir:.*,output-dir: ${testfolder},g" \
					    ${settings} > ${tmp_settings}

#create links to already preprocessed sample data
samplesheet=${srcdir}/tests/sample_sheet.csv
tmp_samplesheet="${testfolder}/sample_sheet.csv"
sed '1p;3p;5q;d' ${samplesheet} > ${tmp_samplesheet}

${builddir}/pigx-bsseq -s ${tmp_settings} --reason --target mapping ${tmp_samplesheet}

rm ${tmp_settings} ${tmp_samplesheet}

rm -rf ${testfolder}/02_trimming/
rm -rf ${testfolder}/03_posttrimming_QC/

if ! test -f ${testfolder}/04_mapping/PEsample_rrbs_1_val_1_bismark_bt2_pe.bam
then
	  echo "ERROR: failed to align paired-end reads with bismark"
	    exit 1
	fi

if ! test -f ${testfolder}/04_mapping/SEsample_v2_trimmed_bismark_bt2.bam
then
	  echo "ERROR: failed to align single-end reads with bismark"
	    exit 1
	fi
